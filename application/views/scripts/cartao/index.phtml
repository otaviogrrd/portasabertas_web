<?php
$auth = Zend_Auth::getInstance ();
$login = $auth->getIdentity();
$permissoes=array(1,2,4);
if($auth->hasIdentity() && in_array($login->nivel,$permissoes)){?>

<?php 
$this->headScript()
	->appendFile($this->baseUrl() . '/js/jquery/js/jquery-1.5.1.min.js','text/javascript')
	->appendFile($this->baseUrl() . '/js/jquery/js/jquery-ui-1.8.14.custom.min.js','text/javascript')
	->appendFile($this->baseUrl() . '/js/scandit.js','text/javascript');
	
$this->headLink()
	->appendStylesheet($this->baseUrl() . '/js/jquery/css/custom-theme/jquery-ui-1.8.14.custom.css');

	
$this->headScript()->captureStart();
?>
 <style type="text/css" media="screen">
     .cartaoDenario{
        background-color: green;
     }
 </style>
 <div class="tituloPag">Cartões</div>


<br>
<br>

<button type="button" onclick="showScanner()">  
<svg xmlns="http://www.w3.org/2000/svg" width="60" height="40" viewBox="0 0 127 127"><g fill="none" fill-rule="evenodd"><g class="base" fill="#000000"><g transform="translate(16 70)"><polygon points="26 37 43 37 43 0 26 0"/><polygon points="85 37 94 37 94 0 85 0"/><polygon points="0 37 9 37 9 0 0 0"/><polygon points="11 37 20 37 20 0 11 0"/><polygon points="74 37 83 37 83 0 74 0"/><polygon points="63 37 72 37 72 0 63 0"/><polygon points="46 37 55 37 55 0 46 0"/></g><g transform="translate(16 20)"><polygon points="26 37 43 37 43 0 26 0"/><polygon points="85 37 94 37 94 0 85 0"/><polygon points="0 37 9 37 9 0 0 0"/><polygon points="11 37 20 37 20 0 11 0"/><polygon points="74 37 83 37 83 0 74 0"/><polygon points="63 37 72 37 72 0 63 0"/><polygon points="46 37 55 37 55 0 46 0"/></g><g fill-rule="nonzero"><polygon points="126 0 94 0 94 3.693 122.307 3.693 122.307 32 126 32"/><polygon points="3.693 3.693 32 3.693 32 0 0 0 0 32 3.693 32"/><polygon points="122.307 123.307 94 123.307 94 127 126 127 126 95 122.307 95"/><polygon points="0 127 32 127 32 123.307 3.693 123.307 3.693 95 0 95"/></g></g><polygon class="scanline" fill="#2EC1CE" fill-rule="nonzero" points="0 62 0 65 127 65 127 62"/></g></svg>
</button>
<div id="scandit-barcode-picker"></div>

<form id="myForm" action="<?php $this->url(array("controller"=>"cartao","action"=>"index")) ?>" method="get">
<h2>Informe número do cartão, documento ou nome do portador:</h2><input class="buscar" id="busca" type="text" name="busca" autocomplete="off"> 

<script>	
// Configure the library and activate it with a license key
const licenseKey = "AQe9jBn7BGJdQp37IRMc7htFawpGLLavtGjOzAFkdMoBZKL2l0512jhCrgFjbaqja00wK3ZN7LyLaqetvE5vBjlMpRapIzuGHXTusJBeptqlVrk0VAsapH9l7o2TX6Wp2y9Xudltd78qPZMRVDhE6NMEEzPLvIvTvKf0S2EGJUgPEWPUloAYAjyc5e7HtZ0O/f9sdB+ms2u2cLjk7IfSsQbDfNSBcJD4gyDMWpHDL7JJm0pdvn8RTf6n5mtZYJXdQYZnmuazsPBWRGJ8YOwS9QmoiOlYMZyC1p7fnyZWyPgk7dksSLOpe4A12GOx/o2wr5/j9Wjbxyzva3/rKUoEnVyh5FXPax7aK1CI165B3KoABLD/AjPtLfXBG0JXmwjEx7FEbICljNVTJPDgqq/BXa3iT/gqwSeDK9/uWisKhcGTfwiFt6Z5zwpz1Tz5r1L6fQfLsR1v/EJeZr0E5KBDxQyFYYQzJYutwEVZqpLnY1OqyfQqJCq3OdbayrjP0IWUP5r2E7rNny6A9heIxkLBUumzBGlFsO3La8+iYplI7+rdHYY3yG3Zp5XWccf2C1NACSAnZQ4KgUaOooxatOYwsXkfHeJeMYaw4+khfHQLOZlvKsa7FcLhQg6H+VlXINaumhOzoFpojrBUt1CkJCscUQFtx/COF4BeZXaM8pAlwa4SSma1ltkactaTnL36OlF0A9yV6h/ve59l6XE04Ks1xhxIfoFZOhzvaa9FdBY5Pxjli6Sx+TEkmZBY4mbQ4QVXm0Ea53YM1oiPHhbnRmIJFkFnFo96Wf46FtBLWMddddRBClPMhF3tS/dJ+xuZ8s8K7sgukhI=";
// Configure the engine location, as explained on http://docs.scandit.com/stable/web/index.html
const engineLocation = "https://cdn.jsdelivr.net/npm/scandit-sdk@4.x/build"
const scannerContainer = document.getElementById("scandit-barcode-picker");
scannerContainer.style.visibility =  "hidden";
scannerContainer.style.height =  "0";
let picker;	

const scanInput = document.getElementById("busca");
// Create & start the picker
ScanditSDK.configure(licenseKey, { engineLocation: engineLocation });
ScanditSDK.BarcodePicker.create(scannerContainer)
	.then(barcodePicker => {
		picker = barcodePicker;
			// Create the settings object to be applied to the scanner
			const scanSettings = new ScanditSDK.ScanSettings({
				enabledSymbologies: ["upca"]
			});
			picker.applyScanSettings(scanSettings);
			picker.on("scan", scanResult => {
				stopScanning();
				scanInput.value = scanResult.barcodes[0].data.substring(4, 12);
				document.getElementById("myForm").submit();
			});
			picker.on("scanError", error => alert(error.message));
			picker.resumeScanning();
		})
		.catch(alert);	
		
function showScanner() {	
		scannerContainer.style.visibility =  "visible";
		scannerContainer.style.height =  "initial";
		picker.resumeScanning();
}
function stopScanning() {
	if (picker) {
		picker.pauseScanning();
		scannerContainer.style.visibility =  "hidden";
		scannerContainer.style.height =  "0";
	}
}
</script>
<script>
$(function () {
    $("#busca").focus();
});
</script>

<input class="input-pp" type="submit" value="Buscar">
<div class='cartaoDenario'><h2 style='color:black'> Os cartões com crédito em denário, aparecem destacados em cor verde, como esse texto.</h2></div>
 

</form>
 
<div class="clearfix"><?php echo $this->mensagem  ?>
<?php 
if (isset($_SESSION['ALERTA']) && is_array($_SESSION['ALERTA']))
	foreach ($_SESSION['ALERTA'] as $alerta){
		echo "<h3>{$alerta}</h3><br>";
	}
	unset($_SESSION['ALERTA']);
?></div>
<div id="conteudo_tabela" class="#conteudo_centro">
<br>

 <?php

    if(isset($this->paginator) && count($this->paginator) > 0){
    
    ?>
<table style="width: 950px">
    <thead>
        <tr>
            <th class="rounded-company" style="width: 100px">Número</th>
            <?php if(isset($_REQUEST['busca']) && $_REQUEST['busca']){?>
            <th class="rounded-company" style="width: 100px">Saldo</th>
            <?php }?>
            <th class="rounded-company" style="width: 150px">Portador</th>
            <th class="rounded-company" style="width: 150px">Documento</th>
            <th class="rounded-company" style="width: 100px">Situação</th>
            <th class="rounded-company" style="width: 300px">Ações</th>
            <th class="rounded-company" style="width: 200px">Relatórios</th>
        </tr>
    </thead>
    <tbody>
   
        <?php
		$status=array(0=>'Disponivel', 1 => 'Em uso',2 => 'Desativado');
        foreach($this->paginator as $key): ?>

        <tr class='<?php echo ($key['tem_denario'])? 'cartaoDenario': '';?>'>
            <td class="listar-simples"><?php echo $key['id_cartao']?></td>
            <?php if(isset($_REQUEST['busca']) && $_REQUEST['busca']){?>
            <td class="listar-simples">R$ <?php printf("%.2f",$key['creditos']); ?></td>
            <?php }?>
            <td class="listar-simples"><?php echo $key['descricao']; ?></td>
            <td class="listar-simples"><?php echo $key['documento']; ?></td>
            <td class="listar-simples"><?php echo $status[$key['status']]; ?></td>
        <td class="listar-simples">
        	<?php if ($key['status'] ==1) {
        			#cartao ativo e em uso /relatorios/transacoes?filtro=12345678
        		 	echo '<a href="' . $this->url(array('action'=>'inserircredito','controller'=>'Cartao','id_cartao'=>$key['id_cartao']),null,1).'">Inserir | </a>';
        		 	echo '<a href="' . $this->url(array('action'=>'estorno','controller'=>'Cartao','id_cartao'=>$key['id_cartao']),null,1) .'">Estornar </a>';
        			echo '<a href="' . $this->url(array('action'=>'desativar','controller'=>'Cartao','id_cartao'=>$key['id_cartao'],'s'=>$key['creditos']),null,1).'" onclick="return confirma_desativar(\''.$key['id_cartao'].'\',\''.$key['descricao'].'\',\''.$key['creditos'].'\');"> | Desativar </a>';
 	       			}            	 
            ?>
            </td>
        <td class="listar-simples">
        	<?php if ($key['status'] > 0) {
        			#cartao em uso ou desativado /relatorios/transacoes?filtro=12345678
        		 	echo '<a href="' . $this->url(array('action'=>'transacoesbarraca','controller'=>'relatorios','filtro'=>$key['id_cartao']),null,1).'">Vendas | </a>';
        		 	echo '<a href="' . $this->url(array('action'=>'receita','controller'=>'relatorios','filtro'=>$key['id_cartao']),null,1).'">Créditos</a>';
        			}            	 
            ?>
            </td>

        </tr>
        <?php endforeach; ?>
       
       
       
    
    </tbody>
  
</table>
<?php }
else {
	if (isset($this->paginationControl)){
		echo "<h1>Registro não encontrado</h1>";
		}	
}
   ?>
<br>

 <?php
if (isset($this->paginationControl)){
	echo $this->paginationControl($this->paginator, 'all', 'paginator_item.phtml');
	}
?>
</div>
<?php }?>